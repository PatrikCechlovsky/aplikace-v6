// ============================================================================
// 6) RENDER
// ============================================================================
  if (!canLoad) {
    return (
      <div className="detail-view__section">
        <div className="detail-view__placeholder">
          Přílohy budou dostupné po uložení záznamu.
          <br />
          Režim: <strong>{mode}</strong>
        </div>
      </div>
    )
  }

  const sectionTitle = isManager ? 'Přílohy' : 'Přílohy (read-only)'

  /**
   * ✅ JEDEN ZDROJ PRAVDY PRO ŠÍŘKY SLOUPCŮ
   * Později tohle nahradíme uživatelským nastavením (pořadí/viditelnost),
   * ale teď to zajistí 1:1 vzhled mezi seznamem a historií.
   */
  const sharedColumns: ListViewColumn[] = useMemo(
    () => [
      { key: 'title', label: 'Název', width: '180px' },
      { key: 'description', label: 'Popis', width: '220px' },
      { key: 'file', label: 'Soubor (latest)' },
      { key: 'ver', label: 'Verze', width: '90px' },
      { key: 'uploaded', label: 'Nahráno', width: '240px' },
    ],
    []
  )

  const listRows: ListViewRow<AttachmentRow>[] = useMemo(() => {
    return filteredRows.map((r) => {
      const uploadedName = resolveName(r.version_created_by_name ?? null, r.version_created_by ?? null)
      return {
        id: r.id,
        raw: r,
        data: {
          title: (
            <span className="detail-attachments__cell-title">
              {r.title ?? '—'}
              {r.is_archived ? <span className="detail-attachments__archived-badge">archiv</span> : null}
            </span>
          ),
          description: <span className="detail-attachments__muted">{r.description ?? '—'}</span>,
          file: (
            <button
              type="button"
              className="detail-attachments__link"
              onClick={() => void handleOpenLatestByPath(r.file_path)}
              disabled={!r.file_path}
              title="Otevřít soubor"
            >
              {r.file_name ?? '—'}
            </button>
          ),
          ver: <span className="detail-attachments__muted">v{String(r.version_number ?? 0).padStart(3, '0')}</span>,
          uploaded: (
            <span className="detail-attachments__muted">
              {formatDt(r.version_created_at)} • kdo: {uploadedName}
            </span>
          ),
        },
      }
    })
  }, [filteredRows, resolveName, handleOpenLatestByPath])

  // READ-ONLY UI (nebo manager bez práv)
  if (!isManager) {
    return (
      <div className="detail-view__section">
        {isManagerRequested && (
          <div className="detail-view__placeholder" style={{ marginBottom: 8 }}>
            <strong>Správa příloh je pouze pro čtení.</strong>
            <div style={{ marginTop: 6 }}>{readOnlyReason ?? 'Nemáš oprávnění měnit přílohy nebo je entita archivovaná.'}</div>
          </div>
        )}

        <div className="detail-form">
          <section className="detail-form__section">
            <h3 className="detail-form__section-title">{sectionTitle}</h3>

            {loading && <div className="detail-view__placeholder">Načítám přílohy…</div>}

            {!loading && errorText && (
              <div className="detail-view__placeholder">
                Chyba: <strong>{errorText}</strong>
              </div>
            )}

            {!loading && !errorText && listRows.length === 0 && <div className="detail-view__placeholder">Zatím žádné přílohy.</div>}

            {!loading && !errorText && listRows.length > 0 && (
              <ListView
                columns={sharedColumns}
                rows={listRows}
                filterValue={filterText}
                onFilterChange={setFilterText}
                filterPlaceholder="Hledat podle názvu, popisu nebo souboru..."
                showArchived={includeArchived}
                onShowArchivedChange={setIncludeArchived}
                showArchivedLabel="Zobrazit archivované"
                onRowDoubleClick={(row) => void handleOpenLatestByPath(row.raw?.file_path)}
              />
            )}
          </section>
        </div>
      </div>
    )
  }

  // ==========================================================================
  // MANAGER (ListView + panel + verze/historie) – bez lokálních tlačítek
  // ==========================================================================
  const managerRows: ListViewRow<AttachmentRow>[] = listRows

  const expandedVersions = expandedDocId ? versionsByDocId[expandedDocId] ?? [] : []

  // history rows (sloupce stejné jako nahoře)
  const filteredVersions = useMemo(() => {
    const t = historyFilterText.trim().toLowerCase()
    if (!t) return expandedVersions
    return expandedVersions.filter((v) => {
      const a = (selectedRow?.title ?? '').toLowerCase()
      const b = (selectedRow?.description ?? '').toLowerCase()
      const c = (v.file_name ?? '').toLowerCase()
      const d = `v${String(v.version_number ?? 0).padStart(3, '0')}`.toLowerCase()
      return a.includes(t) || b.includes(t) || c.includes(t) || d.includes(t)
    })
  }, [expandedVersions, historyFilterText, selectedRow])

  const historyRows: ListViewRow<AttachmentVersionRow>[] = useMemo(() => {
    if (!expandedDocId) return []
    return filteredVersions.map((v) => {
      const who = resolveName(null, v.created_by)
      return {
        id: v.id,
        raw: v,
        data: {
          title: (
            <span className="detail-attachments__cell-title">
              {selectedRow?.title ?? '—'}
              {selectedRow?.is_archived ? <span className="detail-attachments__archived-badge">archiv</span> : null}
            </span>
          ),
          description: <span className="detail-attachments__muted">{selectedRow?.description ?? '—'}</span>,
          file: (
            <button type="button" className="detail-attachments__link" onClick={() => void openFileByPath(v.file_path)} title="Otevřít verzi">
              {v.file_name ?? '—'}
            </button>
          ),
          ver: <span className="detail-attachments__muted">v{String(v.version_number ?? 0).padStart(3, '0')}</span>,
          uploaded: (
            <span className="detail-attachments__muted">
              {formatDt(v.created_at)} • kdo: {who}
            </span>
          ),
        },
      }
    })
  }, [expandedDocId, filteredVersions, resolveName, openFileByPath, selectedRow])

  const selectedTitle = selectedRow?.title?.trim() ? selectedRow.title : '—'

  return (
    <div className="detail-view__section">
      <div className="detail-form">
        <section className="detail-form__section">
          <h3 className="detail-form__section-title">{sectionTitle}</h3>

          {errorText && (
            <div className="detail-view__placeholder" style={{ marginTop: 8 }}>
              Chyba: <strong>{errorText}</strong>
            </div>
          )}

          {/* PANEL: NOVÁ PŘÍLOHA (otevírá CommonActions → attachmentsAdd) */}
          {panelOpen && (
            <div className="detail-attachments__panel" style={{ marginTop: 10 }}>
              <div className="detail-attachments__panel-grid">
                <div className="detail-form__field detail-form__field--span-6">
                  <label className="detail-form__label">Název</label>
                  <input className="detail-form__input" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} placeholder="Název přílohy" />
                </div>

                <div className="detail-form__field detail-form__field--span-6">
                  <label className="detail-form__label">Popis</label>
                  <input className="detail-form__input" value={newDesc} onChange={(e) => setNewDesc(e.target.value)} placeholder="(volitelné)" />
                </div>

                <div className="detail-form__field detail-form__field--span-6">
                  <label className="detail-form__label">Soubor</label>
                  <input className="detail-form__input" type="file" onChange={(e) => setNewFile(e.target.files?.[0] ?? null)} />
                  {newFile && <div className="detail-form__hint">Vybráno: {newFile.name}</div>}
                </div>
              </div>

              {saving && <div className="detail-form__hint" style={{ marginTop: 10 }}>Ukládám…</div>}
              <div className="detail-form__hint" style={{ marginTop: 6 }}>
                Uložení se provádí přes CommonActions tlačítko <strong>Uložit</strong>.
              </div>
            </div>
          )}

          {/* PANEL: EDIT METADATA (otevírá CommonActions → attachmentsEdit) */}
          {editingDocId && (
            <div className="detail-attachments__panel" style={{ marginTop: 10 }}>
              <div className="detail-form__hint" style={{ marginBottom: 8 }}>Úprava metadat (název / popis)</div>

              <div className="detail-attachments__panel-grid">
                <div className="detail-form__field detail-form__field--span-6">
                  <label className="detail-form__label">Název</label>
                  <input className="detail-form__input" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} />
                </div>

                <div className="detail-form__field detail-form__field--span-6">
                  <label className="detail-form__label">Popis</label>
                  <input className="detail-form__input" value={editDesc} onChange={(e) => setEditDesc(e.target.value)} />
                </div>
              </div>

              {editSaving && <div className="detail-form__hint">Ukládám…</div>}
              <div className="detail-form__hint" style={{ marginTop: 6 }}>
                Uložení se provádí přes CommonActions tlačítko <strong>Uložit</strong>.
              </div>
            </div>
          )}

          {loading && <div className="detail-view__placeholder">Načítám přílohy…</div>}

          {!loading && managerRows.length === 0 && <div className="detail-view__placeholder">Zatím žádné přílohy.</div>}

          {/* LIST */}
          {!loading && managerRows.length > 0 && (
            <ListView
              columns={sharedColumns}
              rows={managerRows}
              filterValue={filterText}
              onFilterChange={setFilterText}
              filterPlaceholder="Hledat podle názvu, popisu nebo souboru..."
              showArchived={includeArchived}
              onShowArchivedChange={setIncludeArchived}
              showArchivedLabel="Zobrazit archivované"
              selectedId={selectedDocId}
              onRowClick={(row) => setSelectedDocId(String(row.id))}
              onRowDoubleClick={(row) => void handleOpenLatestByPath(row.raw?.file_path)}
            />
          )}

          {/* hidden inputs for new version */}
          {filteredRows.map((r) => (
            <input
              key={r.id}
              ref={(el) => setVersionInputRef(r.id, el)}
              type="file"
              className="detail-attachments__file-input"
              onChange={(e) => void handleNewVersionSelected(r.id, e.target.files?.[0] ?? null)}
            />
          ))}

          {/* HISTORY (otevírá CommonActions → attachmentsHistory) */}
          {expandedDocId && (
            <div className="detail-attachments__history" style={{ marginTop: 12 }}>
              <div className="detail-attachments__history-head">
                <div className="detail-attachments__history-title">Historie verzí</div>
                <div className="detail-attachments__history-selected">{selectedTitle}</div>
              </div>

              {versionsLoadingId === expandedDocId && <div className="detail-view__placeholder">Načítám historii…</div>}

              {versionsLoadingId !== expandedDocId && historyRows.length === 0 && <div className="detail-view__placeholder">Žádná historie.</div>}

              {versionsLoadingId !== expandedDocId && historyRows.length > 0 && (
                <ListView
                  columns={sharedColumns}
                  rows={historyRows}
                  filterValue={historyFilterText}
                  onFilterChange={setHistoryFilterText}
                  filterPlaceholder="Hledat podle názvu, popisu nebo souboru..."
                />
              )}
            </div>
          )}
        </section>
      </div>
    </div>
  )
}
